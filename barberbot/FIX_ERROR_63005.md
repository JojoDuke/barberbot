# Fix for Twilio Error 63005 - WhatsApp Message Rejection

## Problem
Twilio was returning error **63005**: "Channel did not accept given content" when trying to send WhatsApp messages. Messages were being generated by the bot but rejected by WhatsApp before delivery.

## Root Cause
The AI agent was generating responses with markdown formatting that WhatsApp doesn't support through Twilio's API:
- Markdown headers (`## Header`)
- Code blocks (` ``` `)
- Markdown links (`[text](url)`)
- Double/triple asterisks (`**bold**`, `***bold***`)
- Other unsupported formatting characters

## Solutions Implemented

### 1. Enhanced Message Sanitizer (`sendWhatsappMessage.ts`)
Updated the `sanitizeWhatsAppMessage()` function to:
- Remove all markdown headers (`#`, `##`, `###`, etc.)
- Strip code blocks (both inline and multi-line)
- Convert markdown links to plain text (preserving link text)
- Normalize markdown bold to WhatsApp format (double asterisks `**` ‚Üí single `*`)
- Fix bullet points (convert `-` and `+` to `‚Ä¢`)
- Remove all control characters except newlines and tabs
- Limit message length to 1600 characters (WhatsApp/Twilio limit)
- Add comprehensive validation before sending

### 2. Updated Agent Instructions (`bridget-agent.ts`)
Made WhatsApp formatting rules explicit and prominent:
- Added "CRITICAL - WhatsApp formatting rules" section
- Specified exactly what formatting to use (single `*` and `_` only)
- Explicitly prohibited markdown headers, code blocks, and links
- Emphasized using plain text when in doubt
- Removed characters from instructions that could cause parsing issues

### 3. Improved Logging
Added detailed logging to help debug issues:
- Log full AI response before sanitization
- Log sanitized response before sending
- Log TwiML XML being sent to Twilio
- Use visual separators to make logs easier to read
- Validate messages before attempting to send

### 4. Better Error Handling
- Validate incoming messages aren't empty
- Check for empty responses after AI generation
- Verify sanitized messages aren't empty
- Provide meaningful error messages in all cases
- Graceful fallbacks for typing indicators

### 5. Status Callback Endpoint
Already had `/whatsapp/status` endpoint that logs:
- Message SID
- Delivery status
- Error codes and messages (if any)

## Testing

### Run the Test Suite
```bash
cd barberbot
tsx whatsapp_layer/test-message-sanitizer.ts
```

This will test the sanitizer against common problematic patterns.

### Test the Live Bot
1. Start the server:
   ```bash
   pnpm whatsapp:watch
   ```

2. Send a test message to your WhatsApp bot

3. Check the console logs for:
   - `ü§ñ Bot response` (raw AI output)
   - `‚ú® Sanitized response` (cleaned output)
   - `üì§ Sending TwiML response` (final XML)

4. Check Twilio logs:
   - Go to [Twilio Console ‚Üí Monitor ‚Üí Logs](https://console.twilio.com/us1/monitor/logs/errors)
   - Look for error 63005 or other errors

## Twilio Webhook Setup

Make sure your Twilio WhatsApp sandbox is configured with:
- **Incoming message webhook**: `https://your-domain.com/whatsapp` (POST)
- **Status callback URL**: `https://your-domain.com/whatsapp/status` (POST)

See `TWILIO_SETUP.md` for detailed setup instructions.

## WhatsApp Formatting Reference

### ‚úÖ Supported by WhatsApp
- `*bold*` - Bold text
- `_italic_` - Italic text
- `~strikethrough~` - Strikethrough text
- Emojis: üåü ‚úÖ üìÖ üïê üíà
- Plain text
- Line breaks
- Bullet points: ‚Ä¢

### ‚ùå NOT Supported (Will Cause Error 63005)
- `**bold**` or `***bold***` - Markdown bold
- `# Header` - Markdown headers
- `` `code` `` - Inline code
- ` ``` code block ``` ` - Code blocks
- `[link](url)` - Markdown links
- Unicode control characters (U+0000-U+001F, U+007F-U+009F)
- Messages over 1600 characters

## Common Issues & Fixes

### Issue: Still getting error 63005
**Check:**
1. Run the test sanitizer to verify it's working
2. Check console logs for the sanitized output
3. Look for any special characters or formatting
4. Verify message length < 1600 characters
5. Check Twilio logs for the exact error details

### Issue: Messages are too long
**Solution:**
- The sanitizer automatically truncates to 1500 characters
- Consider breaking long responses into multiple messages
- Update agent instructions to be more concise

### Issue: Emojis not working
**Solution:**
- Emojis should work fine
- If specific emojis fail, they might not be supported by WhatsApp
- Stick to common emojis

### Issue: Formatting looks wrong
**Solution:**
- WhatsApp only supports basic formatting
- Use single `*` for bold, single `_` for italic
- Test formatting on your own WhatsApp first

## Verification Checklist

- [ ] Message sanitizer removes all markdown headers
- [ ] Code blocks are stripped from responses
- [ ] Markdown links are converted to plain text
- [ ] Double/triple asterisks converted to single
- [ ] Messages under 1600 characters
- [ ] Console logs show sanitized output
- [ ] Status callback URL configured in Twilio
- [ ] Test message successfully delivered
- [ ] No error 63005 in Twilio logs

## Additional Resources

- [Twilio WhatsApp Formatting Guide](https://www.twilio.com/docs/whatsapp/message-types)
- [WhatsApp Message Format Documentation](https://faq.whatsapp.com/539178204879377/)
- [Twilio Error Codes Reference](https://www.twilio.com/docs/api/errors)
- Project file: `barberbot/TWILIO_SETUP.md`

